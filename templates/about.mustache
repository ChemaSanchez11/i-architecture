<div id="img-wrapper" class="d-flex align-items-center justify-content-center position-relative">
    <img id="img-cover" src="{{#print_img}}{{img}}{{/print_img}}" alt="GIF proyectos">

    {{#is_manager}}
        <!-- BOTÃ“N EDITAR -->
        <button
                class="btn btn-dark position-absolute bottom-0 end-0 m-3"
                data-bs-toggle="modal"
                data-bs-target="#modalCropper">
            Cambiar imagen
        </button>
    {{/is_manager}}
</div>


<section id="contacto" class="bg-brown text-white py-5 position-relative" style="background-image: url('./assets/images/{{img_footer}}');">
    <div class="container">
        <div class="row align-items-center g-4">

            <!-- CONTACTO -->
            <div class="col-12 col-md-6">
                <small class="text-contact d-block mb-5">Contacto</small>

                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-instagram me-2"></i>
                    <a href="https://www.instagram.com/impactarchitecture_" target="_blank" class="text-white">
                        impactarchitecture_
                    </a>
                </div>

                <div class="d-flex align-items-center">
                    <i class="bi bi-envelope me-2"></i>
                    <a href="mailto:info@i-architecture.com" target="_blank" class="text-white">
                        info@i-architecture.com
                    </a>
                </div>
            </div>

            <!-- MAPA -->
            <div class="col-12 col-md-6">
                <div class="ratio ratio-16x9 rounded overflow-hidden">
                    <iframe
                            src="https://www.google.com/maps?q=San Andres Estrata, 31, 48510 Valle de Trapaga / Trapagaran, Bizkaia&output=embed"
                            loading="lazy"
                            referrerpolicy="no-referrer-when-downgrade">
                    </iframe>
                </div>
            </div>

        </div>
    </div>
    {{#is_manager}}
        <button
                class="btn btn-dark position-absolute bottom-0 end-0 m-3"
                data-bs-toggle="modal"
                data-bs-target="#modalCropperContacto">
            Cambiar fondo
        </button>
    {{/is_manager}}
</section>

<div class="modal fade" id="modalCropper" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Editar imagen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body text-center">
                <input type="file" id="inputImage" accept="image/*" class="form-control mb-3">

                <div>
                    <img id="cropperImage" style="max-width:100%; display:none;">
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-primary" id="saveCrop">Guardar</button>
            </div>

        </div>
    </div>
</div>
<div class="modal fade" id="modalCropperContacto" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Editar fondo de contacto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body text-center">
                <input type="file" id="inputImageContacto" accept="image/*" class="form-control mb-3">

                <div>
                    <img id="cropperImageContacto" style="max-width:100%; display:none;">
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-primary" id="saveCropContacto">Guardar</button>
            </div>

        </div>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

{{#is_manager}}
    <link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script>
        let cropper;
        const inputImage = document.getElementById('inputImage');
        const cropperImage = document.getElementById('cropperImage');

        inputImage.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = () => {
                cropperImage.src = reader.result;
                cropperImage.style.display = 'block';

                if (cropper) cropper.destroy();

                cropper = new Cropper(cropperImage, {
                    aspectRatio: 16 / 9,
                    viewMode: 2,
                    autoCropArea: 1,
                    responsive: true
                });
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('saveCrop').addEventListener('click', function () {
            if (!cropper) return;

            cropper.getCroppedCanvas({
                width: 1920,
                height: 1080
            }).toBlob(blob => {

                const formData = new FormData();
                formData.append('image', blob);
                formData.append('name', 'img_about');

                $.ajax({
                    url: '/i-architecture/api/update_about',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success(response) {
                        location.reload();
                    },
                    error() {
                        alert('Error al actualizar');
                    }
                });
            }, 'image/jpeg', 0.9);
        });
    </script>
    <script>
        let cropperContacto;
        let originalMime = null;
        const inputImageContacto = document.getElementById('inputImageContacto');
        const cropperImageContacto = document.getElementById('cropperImageContacto');

        inputImageContacto.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            originalMime = file.type;

            const reader = new FileReader();
            reader.onload = () => {
                cropperImageContacto.src = reader.result;
                cropperImageContacto.style.display = 'block';

                if (cropperContacto) cropperContacto.destroy();

                cropperContacto = new Cropper(cropperImageContacto, {
                    aspectRatio: 16 / 9,
                    viewMode: 2,
                    autoCropArea: 1,
                    responsive: true
                });
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('saveCropContacto').addEventListener('click', function () {

            // ðŸ‘‰ SI ES GIF, lo subimos tal cual
            if (originalMime === 'image/gif') {
                const file = inputImageContacto.files[0];
                const formData = new FormData();
                formData.append('image', file);
                formData.append('name', 'img_about_footer');

                sendAjax(formData);
                return;
            }

            // ðŸ‘‰ SI ES IMAGEN NORMAL â†’ crop
            if (!cropperContacto) return;

            cropperContacto.getCroppedCanvas({
                width: 1920,
                height: 1080
            }).toBlob(blob => {

                const formData = new FormData();
                formData.append('image', blob, 'cropped.png');
                formData.append('name', 'img_about_footer');

                sendAjax(formData);

            }, 'image/png', 0.9);
        });

        function sendAjax(formData) {
            $.ajax({
                url: '/i-architecture/api/update_about',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success() {
                    location.reload();
                },
                error() {
                    alert('Error al actualizar el fondo');
                }
            });
        }
    </script>
{{/is_manager}}
